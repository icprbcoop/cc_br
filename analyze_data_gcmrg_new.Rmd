---
title: "Bureau of Reclamation Projections"
author: "Cherie Schultz"
date: "August, 2019"
output:
  word_document: default
  html_document:
    df_print: paged
subtile: GCM bias-corrected data
---
```{r include=FALSE}
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# Initial setup; key inputs
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------

library(tidyverse)
library(dplyr)
library(RcppRoll)
library(data.table)
library(zoo)
library(ggplot2)
#
source("code/functions/read_br_spatialave_func.R", local = TRUE)

# Want to be able to easily change key inputs ---------------------------------
pcriteria <- 0.25 # preliminary criteria
tcriteria <- 0.15
```

```{r setup, include=FALSE}
# This is for setting global options, but don't think it is being used here
knitr::opts_chunk$set(echo = FALSE)
```
## Import Data - rgrd5

```{r include=FALSE}
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# Read the data files that are dataset specific
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------

# The following depend on the dataset -----------------------------------------
ts_path <- "input/gcm_cmip5"
dataset <- "rgrd5"

# Other global inputs ---------------------------------------------------------
ts_output <- "output"

# Read BR precip --------------------------------------------------------------
#    - projections & observed monthly average precipitation rate (mm/day)
#    (the function creates a df with columns: year, month, run, val, type)

precip.df <- read_br_spatialave_func(ts_path,
                                     datatype = "pave",
                                          subfolder_obs = "1obs",
                                          subfolder_proj = dataset,
                                          observed_data_id = "pr",
                                          projection_data_id = "pr")

# Read temp -------------------------------------------------------------------
#    - projections & observed monthly average surface air temp (deg C)

tave.df <- read_br_spatialave_func(ts_path,
                                     datatype = "tave",
                                          subfolder_obs = "1obs",
                                          subfolder_proj = dataset,
                                          observed_data_id = "tas",
                                          projection_data_id = "tas")

```

```{r include=FALSE}
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# Read other data files and create master monthly met data df - met.df
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------

# Read days_in_month.csv ------------------------------------------------------ 
#   (created in Excel: number of days in each month from Jan 1950 - Dec 2099)
days_in_month.df <- file.path("data/days_in_month.csv") %>%
    data.table::fread(
      data.table = FALSE,
      header = TRUE,
      showProgress = FALSE)

# Read the PRISM data ---------------------------------------------------
# Units of precip are mm per month, so convert to mm/day to match BR data
prism_path <- "input"
p.prism.df <- file.path(prism_path, "precip_monthly_mm_prism.csv") %>%
    data.table::fread(
      data.table = FALSE,
      header = TRUE,
      showProgress = FALSE)
p.prism.df <- p.prism.df %>%
  dplyr::mutate(pmave = basin_ave) %>%
  dplyr::right_join(days_in_month.df, by = c("year", "month")) %>%
  dplyr::mutate(pmave = pmave/days_in_month) %>%
  dplyr::select(year, month, pmave)

t.prism.df <- file.path(prism_path, "temp_monthly_degc_prism.csv") %>%
    data.table::fread(
      data.table = FALSE,
      header = TRUE,
      showProgress = FALSE)
t.prism.df <- t.prism.df %>%
  dplyr::mutate(tmave = basin_ave) %>%
  dplyr::select(year, month, tmave)

prism.df <- left_join(p.prism.df, t.prism.df, by = c("year", "month"))
prism.df <- prism.df %>%
  dplyr::mutate(run = "obs_prism", rcp = "obs_prism") %>%
  dplyr::select(year, month, run, rcp, pmave, tmave)

# Create rcp category in BR precip data df ------------------------------------
precip.df <- precip.df %>%
  mutate(pave = val,
         rcp = case_when(
           str_detect(run, "rcp26") == TRUE ~ "rcp26",
           str_detect(run, "rcp45") == TRUE ~ "rcp45",
           str_detect(run, "rcp60") == TRUE ~ "rcp60",
           str_detect(run, "rcp85") == TRUE ~ "rcp85",
           str_detect(run, "obs") == TRUE ~ "obs_br",
  TRUE ~ "NA_what")
         ) %>%
  select(year, month, run, rcp, pave)

tave.df <- tave.df %>%
  mutate(tave = val) %>%
  select(year, month, run, tave)

# Combine BR precip & temp data ----------------------------------------------- 
#    (met.df cols: year, month, run, rcp, 
#                  pmave (monthly, mm/day), tmave (monthly, deg C) )
met.df <- left_join(precip.df, tave.df, by = c("year", "month", "run"))
met.df <- met.df %>%
  dplyr::mutate(pmave = pave, tmave = tave) %>%
  dplyr::select(-pave, -tave) %>%
  dplyr::filter(pmave != "NA")

# Add the PRISM data to the BR data; discard dates with no data ---------------
met.df <- bind_rows(met.df, prism.df) %>%
  dplyr::filter(year != "NA") %>%
  dplyr::filter(!(run == "obs_prism" & pmave == "NA"))

# Add a column for 30-year eras -----------------------------------------------
# First need to delete years that we aren't using -----------------------------
# Also delete era = 2020 for obs_prism - since only 12 years
met.df <- met.df %>%
  dplyr::filter(year >= 1950 & year < 2095) %>%
  dplyr::mutate(era = as.integer(case_when(
    year >= 1950 & year < 1980 ~ 1965, # base period, if delta q?
    year >= 1980 & year < 2005 ~ 1992, # just 25 years - for verification?
    year >= 2005 & year < 2035 ~ 2020, 
    year >= 2035 & year < 2065 ~ 2050, # forecast period
    year >= 2065 & year < 2095 ~ 2080, 
    TRUE ~ -99999
  ))) %>%
  dplyr::filter(!(rcp == "obs_prism" & era >= 2020)) %>%
  dplyr::select(year, month, era, run, rcp, pmave, tmave)
```

## Characterize meteorological data

Because we are interested in "long-term" average conditions, the record will be divided up into "eras", each about 30 years in length. The first era is 1950-1979, and it will be used as the "base" time period for measuring changes in long-term mean flows. Mean flow at Little Falls for the base era is 350 mm (11,741 cfs), just 0.5% less than mean flow for the period, 1897-1979, 351 mm (11,772 cfs). Mean precipitation is 992 mm in both periods! [The only thing that doesn't match so well is mean temperature: 11.2 deg C for 1896-1979 and 11.0 deg C for 1950-1979.] This latter period, 1896-1979, was used to generate the coefficients for the regression model which predicts flow, as a percent of mean flow, precipitation as a percent of mean precipitation, precipitation squared as a percent of mean precipitation squared, and change in temperature, from mean temperature in 1897-1979. 
```{r include=FALSE}
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# Examine unfiltered precip & temp data
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------

# Create df with annual averages by run by year -------------------------------
#   (note pmave is mm per day)
#   (pave_annual in mm per year and tave_annual in deg C)
met.annual.df <- met.df %>%
  dplyr::group_by(year, era, run, rcp) %>%
  dplyr::right_join(days_in_month.df, by = c("year", "month")) %>%
  dplyr::filter(!era=="NA") %>%
  dplyr::mutate(pmave = pmave*days_in_month) %>% # units from mm/day -> mm/month
  dplyr::summarise(pave_annual = sum(pmave),
                   tave_annual = mean(tmave)) %>%
  ungroup()


# Calculate long-term (lt) run stats by era -----------------------------------
  met.run.ltstats.df <- met.annual.df %>%
    dplyr::mutate(p = pave_annual, t = tave_annual) %>%
    dplyr::group_by(run, rcp, era) %>%
    dplyr::summarise(pltmean = mean(p),
                     pltsd = sd(p),
                     pltmin = min(p),
                     plt05 = quantile(p, probs = 0.05, na.rm = TRUE),
                     plt10 = quantile(p, probs = 0.1, na.rm = TRUE),
                     plt25 = quantile(p, probs = 0.25, na.rm = TRUE),
                     plt50 = quantile(p, probs = 0.5, na.rm = TRUE),
                     plt75 = quantile(p, probs = 0.75, na.rm = TRUE),
                     plt90 = quantile(p, probs = 0.9, na.rm = TRUE),
                     plt95 = quantile(p, probs = 0.95, na.rm = TRUE),
                     pltmax = max(p),
                     tltmean = mean(t),
                     tltsd = sd(t),
                     tltmin = min(t),
                     tlt05 = quantile(t, probs = 0.05, na.rm = TRUE),
                     tlt10 = quantile(t, probs = 0.1, na.rm = TRUE),
                     tlt25 = quantile(t, probs = 0.25, na.rm = TRUE),
                     tlt50 = quantile(t, probs = 0.5, na.rm = TRUE),
                     tlt75 = quantile(t, probs = 0.75, na.rm = TRUE),
                     tlt90 = quantile(t, probs = 0.9, na.rm = TRUE),
                     tlt95 = quantile(t, probs = 0.95, na.rm = TRUE),
                     tltmax = max(t)) %>%
  dplyr::mutate_at(4:14, round, 0) %>%
  dplyr::mutate_at(15:25, round, 1) %>%
    dplyr::arrange(rcp, run, era) %>% # so rcp = "obs", era = 1990 is in row 3
  dplyr::ungroup()

# Count runs in rcp's ---------------------------------------------------------
rcp.count.df <- met.run.ltstats.df %>%
  dplyr::group_by(rcp) %>%
  dplyr::count(run) %>%
  dplyr::ungroup()
rcp.count.df <- rcp.count.df %>%
  dplyr::group_by(rcp) %>%
  dplyr::count(rcp) %>%
  dplyr::ungroup()

# Compute stats for each rcp --------------------------------------------------
met.rcp.stats.df <- met.run.ltstats.df %>%
  dplyr::group_by(rcp, era) %>%
  dplyr::summarise(pltmin_median = median(pltmin),
                   plt05_median = median(plt05),
                   plt10_median = median(plt10),
                   plt25_median = median(plt25),
                   plt50_median = median(plt50),
                   plt75_median = median(plt75),
                   plt90_median = median(plt90),
                   plt95_median = median(plt95),
                   pltmean_median = median(pltmean),
                   pltmean90 = quantile(pltmean, probs = 0.90, na.rm = TRUE),
                   pltmean75 = quantile(pltmean, probs = 0.75, na.rm = TRUE),
                   pltmean50 = quantile(pltmean, probs = 0.50, na.rm = TRUE),
                   pltmean25 = quantile(pltmean, probs = 0.25, na.rm = TRUE),
                   pltmean10 = quantile(pltmean, probs = 0.10, na.rm = TRUE),
                   pltsd_median = median(pltsd),
                   tlt05_median = median(tlt05),
                   tlt10_median = median(tlt10),
                   tlt25_median = median(tlt25),
                   tlt50_median = median(tlt50),
                   tlt75_median = median(tlt75),
                   tlt90_median = median(tlt90),
                   tlt95_median = median(tlt95),
                   tltmean_median = median(tltmean),
                   tltsd_median = median(tltsd),
                   metlt_n = n()
                   ) %>%
  dplyr::mutate_at(3:22, round, 2) %>%
  dplyr::ungroup()

# Save the wide format table for display --------------------------------------
met.rcp.stats.wide <- met.rcp.stats.df  %>%
  dplyr::select(rcp, era, metlt_n, 
                plt05_median, plt25_median, plt50_median, plt75_median, 
                plt95_median, pltmean_median, pltsd_median,
                tlt05_median, tlt25_median, tlt50_median, tlt75_median, 
                tlt95_median, tltmean_median, tltsd_median)

# Switch to long format for graphing ------------------------------------------
met.rcp.stats.df <- met.rcp.stats.df %>%
  tidyr::gather(key = "stat", value = "val", -rcp, -era)

# Take a peek at unfiltered annual data ---------------------------------------
p_mean_sd <- met.rcp.stats.df %>%
  dplyr::filter(stat == "pltsd_median" | stat == "pltmean_median")
p_p05_p95 <- met.rcp.stats.df %>%
  dplyr::filter(stat == "pltmin_median" | stat == "plt05_median" | 
                stat == "plt25_median" | stat == "plt75_median" | 
                  stat == "plt95_median")

p_mean_10_90 <- met.rcp.stats.df %>%
  dplyr::filter(stat == "pltmean10" | stat == "pltmean25"
                 | stat == "pltmean50" | stat == "pltmean75"
                 | stat == "pltmean90")

t_mean_sd <- met.rcp.stats.df %>%
  dplyr::filter(stat == "tltsd_median" | stat == "tltmean_median")
t_t05_t95 <- met.rcp.stats.df %>%
  dplyr::filter(stat == "tlt05_median" | stat == "tlt25_median" | 
                  stat == "tlt75_median" | stat == "tlt95_median")

# and also at monthly data ----------------------------------------------------
met.monthly.df <- met.df %>%
  group_by(month, era, rcp) %>%
  dplyr::right_join(days_in_month.df, by = c("year", "month")) %>%
  dplyr::filter(!era=="NA") %>%
  dplyr::mutate(pmave = pmave*days_in_month) %>% # units from mm/day -> mm/month
  dplyr::summarise(pave_monthly = mean(pmave),
                   tave_monthly = mean(tmave)) %>%
  ungroup()
# Create some monthly df's for graphing ---------------------------------------
p.monthly.rcp <- met.monthly.df %>%
  group_by(month, rcp) %>%
  summarise(pave_monthly = mean(pave_monthly)) %>%
  select(rcp, month, pave_monthly) %>%
  ungroup()
t.monthly.rcp <- met.monthly.df %>%
  group_by(month, rcp) %>%
  summarise(tave_monthly = mean(tave_monthly)) %>%
  select(rcp, month, tave_monthly) %>%
  ungroup()
p.monthly.era <- met.monthly.df %>%
  group_by(month, era) %>%
  summarise(pave_monthly = mean(pave_monthly)) %>%
  select(era, month, pave_monthly) %>%
  ungroup()
t.monthly.era <- met.monthly.df %>%
  group_by(month, era) %>%
  summarise(tave_monthly = mean(tave_monthly)) %>%
  select(era, month, tave_monthly) %>%
  ungroup()
 
```
## Examine stats by rcp of unfiltered run

Below is a table with the number of unfiltered runs for each RCP. Also shown are graphs of predicted trends by RCP. For each run, stats were computed for the 25-30 year "eras". Then the median of the run stats were computed for each RCP and for the observed data.
```{r}
knitr::kable(rcp.count.df)
```

```{r}
# Graph annual ave data
# ggplot(data = p_mean_sd, aes(x = era, y = val))  +
#   geom_line(aes(linetype = rcp, colour = stat)) +
#   ggtitle("Precip medians of run lt means and stdevs by RCP") +
#   scale_y_continuous(name = "Precipitation, mm/year", 
#                      limits = c(0, 1200), breaks = seq(0, 1200, 200)) +
#   scale_x_continuous(name = "Year", breaks = c(1960, 1990, 2020, 2050, 2080))
ggplot(data = p_mean_10_90, aes(x = era, y = val))  +
  geom_line(aes(linetype = rcp, colour = stat)) +
  ggtitle("Precip quantiles of run lt means by RCP") +
  scale_y_continuous(name = "Precipitation, mm/year", 
                     limits = c(900, 1200), breaks = seq(900, 1200, 100)) +
  scale_x_continuous(breaks = c(1960, 1990, 2020, 2050, 2080))
ggplot(data = p_p05_p95, aes(x = era, y = val))  +
  geom_line(aes(linetype = rcp, colour = stat)) +
  ggtitle("Precip medians of run lt quantiles and minimums by RCP") +
  # labs(x = "Year", y = "Precipitation, mm per year") +
  scale_y_continuous(name = "Precipitation, mm/year", 
                     limits = c(600, 1400), breaks = seq(600, 1400, 200)) +
  scale_x_continuous(name = "Year",
                     breaks = c(1960, 1990, 2020, 2050, 2080))
ggplot(data = t_mean_sd, aes(x = era, y = val))  +
  geom_line(aes(linetype = rcp, colour = stat)) +
  ggtitle("Temp medians of run lt means and stdevs by RCP") +
  labs(x = "Year", y = "Temperature, deg C") +
#    scale_y_continuous(breaks = seq(0, 50, 10)) +
  scale_x_continuous(breaks = c(1960, 1990, 2020, 2050, 2080))
ggplot(data = t_t05_t95, aes(x = era, y = val))  +
  geom_line(aes(linetype = rcp, colour = stat)) +
  ggtitle("Temp medians of run lt quantiles by RCP") +
  labs(x = "Year", y = "Temperature, deg C")

```

```{r}
# Graph monthly ave data
ggplot(data = p.monthly.rcp, aes(x = month, y = pave_monthly))  +
  geom_line(aes(linetype = rcp)) +
  ggtitle("Precip monthly means by RCP") +
  scale_y_continuous(name = "Precipitation, mm/month", 
                     limits = c(60, 120), breaks = seq(60, 120, 20)) +
  scale_x_continuous(name = "Month", 
                     limits = c(1, 12), breaks = seq(1, 12, 1))
ggplot(data = t.monthly.rcp, aes(x = month, y = tave_monthly))  +
  geom_line(aes(linetype = rcp)) +
  ggtitle("Temp monthly means by RCP") +
  labs(x = "Month", y = "Temperature, deg C")
ggplot(data = p.monthly.era, aes(x = month, y = pave_monthly))  +
  geom_line(aes(colour = factor(era))) +
  ggtitle("Precip monthly means by era") +
  scale_y_continuous(name = "Precipitation, mm/month", 
                     limits = c(60, 120), breaks = seq(60, 120, 20)) +
  scale_x_continuous(name = "Month", 
                     limits = c(1, 12), breaks = seq(1, 12, 1))
ggplot(data = t.monthly.era, aes(x = month, y = tave_monthly))  +
  geom_line(aes(colour = factor(era))) +
  ggtitle("Temp monthly means by era") +
  labs(x = "Month", y = "Temperature, deg C")
```


## Filter runs

Runs are filtered based on performance in the historical base period, 1950-1979. Performance is judged via 10 statistics each for annual average precipitation and annual average temperature:
mean, standard deviation, minimum, maximum, and the following percentiles: 5th, 10th, 25th, 50th, 75th, 90th, 95th.


```{r include=FALSE}
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# Filter the runs
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------

# For now, use prism data for filtering, 
#    - with era = 1965 (1950-1979) for filtering comparison period
#    - I guess we could define another time period for filtering purposes
#    - maybe go back to 1970-1999?, which I think was used in BCSD downscaling

# pf and tf are obs_prism lt base stats, for comparison with model base stats
# row 3 is era = 1965 obs_prism
pf <- met.run.ltstats.df[3,4:14]
tf <- met.run.ltstats.df[3, 15:25]
# pcriteria <- 0.15 # preliminary criteria
# tcriteria <- 0.1
#
# Create columns, ptest and ttest = pass, fail --------------------------------
met.run.ltstats.df <- met.run.ltstats.df %>%
    mutate(ptest = "pass",
           ptest = case_when(
             abs(pltmin - pf$pltmin[1])/pf$pltmin[1] > pcriteria ~ "fail",
             abs(plt05 - pf$plt05[1])/pf$plt05[1] > pcriteria ~ "fail",   
             abs(plt10 - pf$plt10[1])/pf$plt10[1] > pcriteria ~ "fail",
             abs(plt25 - pf$plt25[1])/pf$plt25[1] > pcriteria ~ "fail",
             abs(plt50 - pf$plt50[1])/pf$plt50[1] > pcriteria ~ "fail",
             abs(plt75 - pf$plt75[1])/pf$plt75[1] > pcriteria ~ "fail",
             abs(plt90 - pf$plt90[1])/pf$plt90[1] > pcriteria ~ "fail", 
             abs(plt95 - pf$plt95[1])/pf$plt95[1] > pcriteria ~ "fail",
             # abs(pltmax - pf$pltmax[1])/pf$pltmax[1] > pcriteria*2 ~ "fail",
             # abs(pltsd - pf$pltsd[1])/pf$pltsd[1] > pcriteria ~ "fail",
             is.na(pf$pltmean[1]) ~ "fail",
             TRUE ~ ptest),
           ttest = "pass",
           ttest = case_when(
             abs(tltmin - tf$tltmin[1])/tf$tltmin[1] > tcriteria ~ "fail",
             abs(tlt05 - tf$tlt05[1])/tf$tlt05[1] > tcriteria ~ "fail",   
             abs(tlt10 - tf$tlt10[1])/tf$tlt10[1] > tcriteria ~ "fail",
             abs(tlt25 - tf$tlt25[1])/tf$tlt25[1] > tcriteria ~ "fail",
             abs(tlt50 - tf$tlt50[1])/tf$tlt50[1] > tcriteria ~ "fail",
             abs(tlt75 - tf$tlt75[1])/tf$tlt75[1] > tcriteria ~ "fail",
             abs(tlt90 - tf$tlt90[1])/tf$tlt90[1] > tcriteria ~ "fail", 
             abs(tlt95 - tf$tlt95[1])/tf$tlt95[1] > tcriteria ~ "fail",
             abs(tltmax - tf$tltmax[1])/tf$tltmax[1] > tcriteria ~ "fail",
             # abs(tltsd - tf$tltsd[1])/tf$tltsd[1] > tcriteria ~ "fail",
             is.na(tf$tltmean[1]) ~ "fail",
             TRUE ~ ttest),
             filtertest = if_else(ptest == "pass" & ttest == "pass", 
                                  "pass", "fail")
             )
  
# Create df with filtertest for base period for each run ----------------------
#   (for now the base period is 1980-1999, ie era = 1990)
  
annualfilter.base <- met.run.ltstats.df %>% # this can be used to select the runs
    dplyr::filter(era == 1965) %>%
    mutate(pltmean_base = pltmean, tltmean_base = tltmean) %>%
    dplyr::select(run, filtertest, pltmean_base, tltmean_base) 
  
# Add the filtertest for the base period to met.run.stats.df,
#   - get rid of failing runs, and pare down number of columns
met.frun.ltstats.small.df <- left_join(met.run.ltstats.df, 
                                      annualfilter.base, by = "run") %>%
    mutate(filtertest = filtertest.y) %>%
    dplyr::filter(filtertest == "pass") %>%
    dplyr::select(run, rcp, era, filtertest, 
           pltmean_base, pltmean, pltsd, pltmin, plt05, 
           plt25, plt50, plt75, plt95, pltmax,
           tltmean_base, tltmean, tltsd, tltmin, tlt05, 
           tlt25, tlt50, tlt75, tlt95, tltmax)
  
# Compute stats for each filtered rcp -----------------------------------------
met.frcp.stats.df <- met.frun.ltstats.small.df %>%
    dplyr::group_by(rcp, era) %>%
    dplyr::summarise(pltmin_median = median(pltmin),
                     plt05_median = median(plt05),
                     plt25_median = median(plt25),
                     plt50_median = median(plt50),
                     plt75_median = median(plt75),
                     plt95_median = median(plt95),
                     pltmean_median = median(pltmean),
                     pltsd_median = median(pltsd),
                     pltmean90 = quantile(pltmean, probs = 0.90, na.rm = TRUE),
                     pltmean75 = quantile(pltmean, probs = 0.75, na.rm = TRUE),
                     pltmean50 = quantile(pltmean, probs = 0.50, na.rm = TRUE),
                     pltmean25 = quantile(pltmean, probs = 0.25, na.rm = TRUE),
                     pltmean10 = quantile(pltmean, probs = 0.10, na.rm = TRUE),
                     tlt05_median = median(tlt05),
                     tlt25_median = median(tlt25),
                     tlt50_median = median(tlt50),
                     tlt75_median = median(tlt75),
                     tlt95_median = median(tlt95),
                     tltmean_median = median(tltmean),
                     tltsd_median = median(tltsd) ) %>%
  dplyr::ungroup() %>%
  tidyr::gather(key = "stat", value = "val", -rcp, -era)
  
# Count passing runs by rcp ---------------------------------------------------
rcp.fcount.df <- met.frun.ltstats.small.df %>%
    dplyr::group_by(rcp, filtertest) %>%
    dplyr::filter(filtertest == "pass") %>%
    dplyr::count(run) %>%
    dplyr::ungroup()
rcp.fcount.df <- rcp.fcount.df %>%
    dplyr::group_by(rcp) %>%
    dplyr::count(rcp) %>%
    dplyr::ungroup()
  
# Prepare to graph rcp stats of filtered runs ---------------------------------
p_mean_sd <- met.frcp.stats.df %>%
    dplyr::filter(stat == "pltsd_median" | stat == "pltmean_median")
p_mean_10_90 <- met.frcp.stats.df %>%
  dplyr::filter(stat == "pltmean10" | stat == "pltmean25"
                 | stat == "pltmean50" | stat == "pltmean75"
                 | stat == "pltmean90")
p_p05_p95 <- met.frcp.stats.df %>%
    dplyr::filter(stat == "pltmin_median" | stat == "plt05_median" | 
                    stat == "plt25_median" | stat == "plt50_median" |
                    stat == "plt75_median" | stat == "plt95_median" )
t_mean_sd <- met.frcp.stats.df %>%
    dplyr::filter(stat == "tltsd_median" | stat == "tltmean_median")
t_t05_t95 <- met.frcp.stats.df %>%
    dplyr::filter(stat == "tltmin_median" | stat == "tlt05_median" | 
                    stat == "tlt25_median" | stat == "tlt50_median" |
                    stat == "tlt75_median" | stat == "tlt95_median" )
```
### Results

The filtering criteria is (can change at the beginning of this file): 
  % difference between run stats and observed stats is  < `r pcriteria` for precip and `r tcriteria` for temp. The pmax criteria has been dropped. The total number of passing runs is `r sum(rcp.fcount.df$n[3:6])`. We look at some graphs of trends as well:
```{r}
knitr::kable(rcp.fcount.df)
```

```{r}
# ggplot(data = p_mean_sd, aes(x = era, y = val))  +
#   geom_line(aes(linetype = rcp, colour = stat)) +
#   ggtitle("Precip medians of filtered run lt means and stdevs by RCP") +
#   labs(x = "Year", y = "Precipitation, mm per year")
ggplot(data = p_mean_10_90, aes(x = era, y = val))  +
  geom_line(aes(linetype = rcp, colour = stat)) +
  ggtitle("Precip quantiles of run lt means by RCP") +
  scale_y_continuous(name = "Precipitation, mm/year", 
                     limits = c(900, 1200), breaks = seq(900, 1200, 100)) +
  scale_x_continuous(name = "Year",
                     breaks = c(1960, 1990, 2020, 2050, 2080))
ggplot(data = p_p05_p95, aes(x = era, y = val))  +
  geom_line(aes(linetype = rcp, colour = stat)) +
  ggtitle("Precip medians of filtered run lt quantiles and minimums by RCP") +
  scale_y_continuous(name = "Precipitation, mm/year", 
                     limits = c(600, 1400), breaks = seq(600, 1400, 200)) +
  scale_x_continuous(name = "Year",
                     breaks = c(1960, 1990, 2020, 2050, 2080))
ggplot(data = t_mean_sd, aes(x = era, y = val))  +
  geom_line(aes(linetype = rcp, colour = stat)) +
  ggtitle("Temp medians of filtered run lt means and stdevs by RCP") +
  labs(x = "Year", y = "Temperature, deg C")
ggplot(data = t_t05_t95, aes(x = era, y = val))  +
  geom_line(aes(linetype = rcp, colour = stat)) +
  ggtitle("Temp medians of filtered run lt quantiles by RCP") +
  labs(x = "Year", y = "Temperature, deg C")
```

## Predicted changes in flow

Our simple annual flow sensitivity equation is used to compute average annual flow as a function of average annual temperature and precipitation. No q lag term is present in the regression equation used to generate these preliminary results.

```{r include=FALSE}
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# Add predicted flows
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------

# Add the filtertest info to met annual averages ------------------------------
met.annual.df <-  left_join(met.annual.df, annualfilter.base, by = "run") %>%
  dplyr::arrange(run, year)
met.fannual.df <- met.annual.df %>%
  dplyr::filter(filtertest == "pass")

# Define the climate response function parameters  ----------------------------
#  (based for the time being on annual results "T3", 
#   with 1897-79 averages, no q_lag)
# The T3 regression equation is q_frac = b_dt*dt + b_p*p_frac
# where q, p, and t are annual averages of flow, precip, and temperature, and
#    qfrac = q/qbar
#    dt = t - tbar
#    pfraq = p/pbar
qbar <- 350 # mm
tbar <- 11.19 # deg C
pbar <- 992 # mm
b_dp <- 0.12 # not significant in T3 equation but keep it for now
b_dp2 <- 0.87
b_dt <- -0.073
# b_dt <- b_dt/2 # should do some sensitivity tests
b_0 <- -0.00

# Compute dq predictions annually ---------------------------------------------
#   (for each model run for each year)
q_met.fannual.df <- met.fannual.df %>%
  # mutate(dp = round((pave_annual - pltmean_base)/pltmean_base, 3),
  #        dt = round((tave_annual - tltmean_base), 3),
  #        dq = round(dp*b_dp + dp*dp*b_dp2 + dt*b_dt + b_0, 3),
  #        pave_annual = round(pave_annual, 0),
  #        pltmean_base = round(pltmean_base, 0),
  #        tave_annual = round(tave_annual, 2),
  #        tltmean_base = round(tltmean_base, 2)) %>%
  mutate(pfrac = round(pave_annual/pbar, 3),
         dt = round((tave_annual - tbar), 3),
         qfrac = round(pfrac*b_dp + pfrac*pfrac*b_dp2 + dt*b_dt + b_0, 3),
         pave_annual = round(pave_annual, 0),
         pltmean_base = round(pltmean_base, 0),
         tave_annual = round(tave_annual, 2),
         tltmean_base = round(tltmean_base, 2)) %>%
  dplyr:: select(-filtertest)

# For each run, compute long-term dq stats over each era ----------------------
q.frun.ltstats0.df <- q_met.fannual.df %>%
  group_by(run, era) %>%
  summarise(pltmean = round(mean(pave_annual), 0),
            tltmean = round(mean(tave_annual), 2),
            dqltmean = round(mean(qfrac), 3)
            ) %>%
  ungroup()

# Create df of base = 1965 and 2050 dqltmeans for each run --------------------
# Not really necessary if no q renormalization --------------------------------
qltmean.base_2050.df <- q.frun.ltstats0.df %>%
  dplyr::filter(era == 1965 | era == 2050) %>%
  dplyr::select(-pltmean, -tltmean) %>%
  tidyr::spread(key = "era", value = "dqltmean")
names(qltmean.base_2050.df) <- c("run", "dqltmean_base_orig", "dqltmean_2050_orig")

# Add the dqltmean orig's to the filtered annual df ---------------------------
q_met.fannual.df <- left_join(q_met.fannual.df, qltmean.base_2050.df, 
                           by = c("run"))

# May need to keep thinking about "renormalization" of flows ------------------ # Right now I am NOT RENORMALIZING: -------------------------------------------
# "Renormalize" annual dq values so that dqltmean is 0 for base era -----------
# q_met.fannual.df <- q_met.fannual.df %>%
#   dplyr::mutate(dqr = dq - dqltmean_base_orig, 
#                 dqltmean_2050 = dqltmean_2050_orig - dqltmean_base_orig) 
# q_met.fannual.df <- q_met.fannual.df %>%
#   dplyr::mutate(dqr = dq, 
#                 dqltmean_2050 = dqltmean_2050_orig) 
# Right now I am NOT RENORMALIZING: -------------------------------------------
q_met.fannual.df <- q_met.fannual.df %>%
  dplyr::mutate(qfracr = qfrac, 
                dqltmean_2050 = dqltmean_2050_orig) 

# Compute long-term stats for renormalized dq's -------------------------------
q.frun.ltstats.df <- q_met.fannual.df %>%
  group_by(run, era, rcp) %>%
  summarise(pltmean = mean(pave_annual),
            tltmean = mean(tave_annual),
            dqltmean = mean(qfracr),
            dqltsd = sd(qfracr),
            dqlt975 = quantile(qfracr, probs = 0.975, na.rm = TRUE),
            dqlt95 = quantile(qfracr, probs = 0.95, na.rm = TRUE),
            dqlt90 = quantile(qfracr, probs = 0.90, na.rm = TRUE),
            dqlt75 = quantile(qfracr, probs = 0.75, na.rm = TRUE),
            dqlt50 = quantile(qfracr, probs = 0.50, na.rm = TRUE),
            dqlt25 = quantile(qfracr, probs = 0.25, na.rm = TRUE),
            dqlt10 = quantile(qfracr, probs = 0.10, na.rm = TRUE),
            dqlt05 = quantile(qfracr, probs = 0.05, na.rm = TRUE),
            dqlt025 = quantile(qfracr, probs = 0.025, na.rm = TRUE),
            dqltmin = min(qfracr)
            ) %>%
  mutate_at(4:17, round, 2) %>%
  ungroup()

# Add stats to the filtered annual df -----------------------------------------
q_met.fannual.df <- left_join(q_met.fannual.df, q.frun.ltstats.df, 
                           by = c("run", "era"))

# # Test drought persistence metric ---------------------------------------------
# #    (dpersist = 1 if the current year AND the next year are dry)
# q_met.fannual.drytest <- q_met.fannual.df %>%
#   dplyr::arrange(run, year) %>%
#   mutate(dry = if_else(dq <= dqlt25, 1, 0),
#          nextdry = lead(dry, 1),
#          nextrun = lead(run, 1),
#          dpersist = if_else(dry == 1 & nextdry == 1, 1, 0),
#          dpersist = if_else(nextrun == run, dpersist, 0)) %>%
#   select(-pltmean_base, -tltmean_base, -dp, -dt, 
#          -pave_annual, -tave_annual)
# 
# # For each run, find average dry & dpersist in eras ---------------------------
# #    (result is total dpersist per decade)
# q.frun.drytest <- q_met.fannual.drytest %>%
#   select(run, rcp, era, dqltsd, dry, dpersist) %>%
#   group_by(run, rcp, era) %>%
#   summarise(sum_persist = round(sum(dpersist)/2, 1),
#             sum_dry = round(sum(dry)/2, 1)) %>%
#   ungroup()
# 
# # Add to original q.frun.stats.df -------------------------------------------
# q.frun.ltstats.df <- left_join(q.frun.ltstats.df, q.frun.drytest, 
#                                by = c("run", "era"))
# 
# Summarise lt stats by rcp ---------------------------------------------------
q.rcpmedians <- q.frun.ltstats.df %>%
  group_by(rcp, era) %>%
  summarise(dqltmean_rcpmedian = median(dqltmean),
            dqltsd_rcpmedian = median(dqltsd),
            dqltmin_rcpmedian = median(dqltmin),
            dqlt05_rcpmedian = median(dqlt025),
            dqlt05_rcpmedian = median(dqlt05),
            dqlt25_rcpmedian = median(dqlt25),
            dqlt50_rcpmedian = median(dqlt50),
            dqlt75_rcpmedian = median(dqlt75),
            dqlt95_rcpmedian = median(dqlt95),
            dqlt975_rcpmedian = median(dqlt975)
            # dry_rcpmedian = round(median(sum_dry),3),
            # dpersist_rcpmedian = round(median(sum_persist), 3)) %>%
  ) %>%
  ungroup()

# Calculate quantiles of dqltmean ---------------------------------------------
# Delete rcp = obs_prism and obs_br
dqltmean.stats <- q.frun.ltstats.df %>%
  filter(!(rcp == "obs_prism")) %>%
  filter(!(rcp == "obs_br")) %>%
  group_by(era) %>%
  summarise(dqltmean_min = min(dqltmean),
            dqltmean_025 = quantile(dqltmean, probs = 0.025, na.rm = TRUE),
            dqltmean_050 = quantile(dqltmean, probs = 0.05, na.rm = TRUE),
            dqltmean_100 = quantile(dqltmean, probs = 0.10, na.rm = TRUE),
            dqltmean_175 = quantile(dqltmean, probs = 0.175, na.rm = TRUE),
            dqltmean_200 = quantile(dqltmean, probs = 0.20, na.rm = TRUE),
            dqltmean_250 = quantile(dqltmean, probs = 0.25, na.rm = TRUE),
            dqltmean_325 = quantile(dqltmean, probs = 0.325, na.rm = TRUE),
            dqltmean_400 = quantile(dqltmean, probs = 0.400, na.rm = TRUE),
            dqltmean_425 = quantile(dqltmean, probs = 0.425, na.rm = TRUE),
            dqltmean_500 = quantile(dqltmean, probs = 0.50, na.rm = TRUE),
            dqltmean_575 = quantile(dqltmean, probs = 0.575, na.rm = TRUE),
            dqltmean_600 = quantile(dqltmean, probs = 0.600, na.rm = TRUE),
            dqltmean_675 = quantile(dqltmean, probs = 0.675, na.rm = TRUE),
            dqltmean_750 = quantile(dqltmean, probs = 0.75, na.rm = TRUE),
            dqltmean_800 = quantile(dqltmean, probs = 0.800, na.rm = TRUE),
            dqltmean_825 = quantile(dqltmean, probs = 0.825, na.rm = TRUE),
            dqltmean_900 = quantile(dqltmean, probs = 0.90, na.rm = TRUE),
            dqltmean_950 = quantile(dqltmean, probs = 0.95, na.rm = TRUE),
            dqltmean_975 = quantile(dqltmean, probs = 0.975, na.rm = TRUE),
            dqltmean_max = max(dqltmean)) %>%
  mutate_all(round, 2) %>%
  ungroup()

# Prepare for graphing --------------------------------------------------------
#   (dry and dpersist are so boring don't bother graphing)
q.rcp.stats.long <- q.rcpmedians %>%
  tidyr::gather(key = "stat", value = "val", -rcp, -era)

q_mean_sd <- q.rcp.stats.long %>%
    dplyr::filter(stat == "dqltmean_rcpmedian" | stat == "dqltsd_rcpmedian")
q_q05_q95 <- q.rcp.stats.long %>%
    dplyr::filter(stat == "dqlt05_rcpmedian" | stat == "dqlt25_rcpmedian"
                  | stat == "dqlt50_rcpmedian" | stat == "dqlt75_rcpmedian" 
                  | stat == "dqlt95_rcpmedian" | stat == "dqltmin_rcpmedian")

dqltmean.stats.long <- dqltmean.stats %>%
  tidyr::gather(key = "stat", value = "val", -era)

dqltmean_q05_q95 <- dqltmean.stats.long %>%
    dplyr::filter(stat == "dqltmean_050" | stat == "dqltmean_100"
                  | stat == "dqltmean_250"
                  | stat == "dqltmean_500" | stat == "dqltmean_750"
                  | stat == "dqltmean_900" | stat == "dqltmean_950")

```

First, a table of the stats of the long-term run means:

```{r}
# Print out the stats of the long-term mean dq's
knitr::kable(dqltmean.stats)
```

```{r}
# ggplot(data = q_mean_sd, aes(x = era, y = val))  +
#   geom_line(aes(linetype = rcp, colour = stat)) +
#   ggtitle("dq medians by RCP of filtered run mins and stdevs") +
#   labs(x = "Year", y = "Percent change in flow from mean baseline")
ggplot(data = q_q05_q95, aes(x = era, y = val))  +
  geom_line(aes(linetype = rcp, colour = stat)) +
  ggtitle("Medians of filtered runs long-term quantiles") +
  labs(x = "Year", y = "Percent change in flow from mean baseline")
ggplot(data = dqltmean_q05_q95, aes(x = era, y = val))  +
  geom_line(aes(colour = stat)) +
  ggtitle("Quantiles of all filtered run long-term means") +
  labs(x = "Year", y = "Percent change in flow from mean baseline")
```
## Climate change scenarios

```{r include=FALSE}
# -----------------------------------------------------------------------------
# Develop climate change scenarios
# -----------------------------------------------------------------------------

# CAREFUL! - row 4 is 2050 right now but could change -------------------------
limits <- dqltmean.stats[4,] 
cc90_lowerlim <- limits$dqltmean_025[1]
cc90_upperlim <- limits$dqltmean_175[1]
cc75_lowerlim <- limits$dqltmean_175[1]
cc75_upperlim <- limits$dqltmean_325[1]
cc50_lowerlim <- limits$dqltmean_425[1]
cc50_upperlim <- limits$dqltmean_575[1]
cc25_lowerlim <- limits$dqltmean_675[1]
cc25_upperlim <- limits$dqltmean_825[1]
cc10_lowerlim <- limits$dqltmean_825[1]
cc10_upperlim <- limits$dqltmean_975[1]


# Look at pools of run results, by year, --------------------------------------
#    with 2050 lt means close to 10, 30, 50 ... percentiles

dq_cc90.runs.df <- q_met.fannual.df %>%
  dplyr::filter(dqltmean_2050 >= cc90_lowerlim &
                  dqltmean_2050 < cc90_upperlim) %>%
  dplyr::select(year, era, run, qfracr, pave_annual, tave_annual)

dq_cc75.runs.df <- q_met.fannual.df %>%
  dplyr::filter(dqltmean_2050 >= cc75_lowerlim &
                  dqltmean_2050 < cc75_upperlim) %>%
  dplyr::select(year, era, run, qfracr, pave_annual, tave_annual)

dq_cc50.runs.df <- q_met.fannual.df %>%
  dplyr::filter(dqltmean_2050 >= cc50_lowerlim &
                  dqltmean_2050 < cc50_upperlim) %>%
  dplyr::select(year, era, run, qfracr, pave_annual, tave_annual)

dq_cc25.runs.df <- q_met.fannual.df %>%
  dplyr::filter(dqltmean_2050 >= cc25_lowerlim &
                  dqltmean_2050 < cc25_upperlim) %>%
  dplyr::select(year, era, run, qfracr, pave_annual, tave_annual)

dq_cc10.runs.df <- q_met.fannual.df %>%
  dplyr::filter(dqltmean_2050 >= cc10_lowerlim &
                  dqltmean_2050 <= cc10_upperlim) %>%
  dplyr::select(year, era, run, qfracr, pave_annual, tave_annual)

dq_cc90 <- dq_cc90.runs.df %>%
  group_by(era) %>%
  summarise(dqrmin = round(min(qfracr), 2),
            dqrlt01 = round(quantile(qfracr, probs = 0.01, na.rm = TRUE), 2),
            dqrlt02 = round(quantile(qfracr, probs = 0.02, na.rm = TRUE), 2),
            dqrlt05 = round(quantile(qfracr, probs = 0.05, na.rm = TRUE), 2),
            dqrlt10 = round(quantile(qfracr, probs = 0.10, na.rm = TRUE), 2),
            dqrlt25 = round(quantile(qfracr, probs = 0.25, na.rm = TRUE), 2),
            dqrlt35 = round(quantile(qfracr, probs = 0.35, na.rm = TRUE), 2),
            dqrlt50 = round(quantile(qfracr, probs = 0.50, na.rm = TRUE), 2),
            dqrlt65 = round(quantile(qfracr, probs = 0.65, na.rm = TRUE), 2),
            dqrlt75 = round(quantile(qfracr, probs = 0.75, na.rm = TRUE), 2),
            dqrlt90 = round(quantile(qfracr, probs = 0.90, na.rm = TRUE), 2),
            qrlt95 = round(quantile(qfracr, probs = 0.95, na.rm = TRUE), 2),
            qrlt98 = round(quantile(qfracr, probs = 0.98, na.rm = TRUE), 2),
            qrlt99 = round(quantile(qfracr, probs = 0.99, na.rm = TRUE), 2),
            dqrmax = round(max(qfracr), 2), 
            dqrcount = n(),
            dqrmean = round(mean(qfracr), 2),
            dqrsd = round(sd(qfracr), 2),
            pltave = round(mean(pave_annual)),
            tltave = round(mean(tave_annual), 2)
            ) %>%
  ungroup()

dq_cc90_long <- dq_cc90 %>%
  dplyr::mutate(era = as.integer(era)) %>%
  dplyr::select(-dqrcount, -dqrsd, -pltave, -tltave,
                -dqrlt35, -dqrlt65, -dqrmean, 
                -dqrmax) %>%
  tidyr::gather(key = "stat", value = "val", -era)

dq_cc75 <- dq_cc75.runs.df %>%
  group_by(era) %>%
  summarise(dqrmin = round(min(qfracr), 2),
            dqrlt01 = round(quantile(qfracr, probs = 0.01, na.rm = TRUE), 2),
            dqrlt02 = round(quantile(qfracr, probs = 0.02, na.rm = TRUE), 2),
            dqrlt05 = round(quantile(qfracr, probs = 0.05, na.rm = TRUE), 2),
            dqrlt10 = round(quantile(qfracr, probs = 0.10, na.rm = TRUE), 2),
            dqrlt25 = round(quantile(qfracr, probs = 0.25, na.rm = TRUE), 2),
            dqrlt35 = round(quantile(qfracr, probs = 0.35, na.rm = TRUE), 2),
            dqrlt50 = round(quantile(qfracr, probs = 0.50, na.rm = TRUE), 2),
            dqrlt65 = round(quantile(qfracr, probs = 0.65, na.rm = TRUE), 2),
            dqrlt75 = round(quantile(qfracr, probs = 0.75, na.rm = TRUE), 2),
            dqrlt90 = round(quantile(qfracr, probs = 0.90, na.rm = TRUE), 2),
            qrlt95 = round(quantile(qfracr, probs = 0.95, na.rm = TRUE), 2),
            qrlt98 = round(quantile(qfracr, probs = 0.98, na.rm = TRUE), 2),
            qrlt99 = round(quantile(qfracr, probs = 0.99, na.rm = TRUE), 2),
            dqrmax = round(max(qfracr), 2), 
            dqrcount = n(),
            dqrmean = round(mean(qfracr), 2),
            dqrsd = round(sd(qfracr), 2),
            pltave = round(mean(pave_annual)),
            tltave = round(mean(tave_annual), 2)
              ) %>%
  ungroup()
dq_cc75_long <- dq_cc75 %>%
  dplyr::mutate(era = as.integer(era)) %>%
  dplyr::select(-dqrcount, -dqrsd, -pltave, -tltave,
                -dqrlt35, -dqrlt65, -dqrmean, 
                -dqrmax) %>%
  tidyr::gather(key = "stat", value = "val", -era)

dq_cc50 <- dq_cc50.runs.df %>%
  group_by(era) %>%
  summarise(dqrmin = round(min(qfracr), 2),
            dqrlt01 = round(quantile(qfracr, probs = 0.01, na.rm = TRUE), 2),
            dqrlt02 = round(quantile(qfracr, probs = 0.02, na.rm = TRUE), 2),
            dqrlt05 = round(quantile(qfracr, probs = 0.05, na.rm = TRUE), 2),
            dqrlt10 = round(quantile(qfracr, probs = 0.10, na.rm = TRUE), 2),
            dqrlt25 = round(quantile(qfracr, probs = 0.25, na.rm = TRUE), 2),
            dqrlt35 = round(quantile(qfracr, probs = 0.35, na.rm = TRUE), 2),
            dqrlt50 = round(quantile(qfracr, probs = 0.50, na.rm = TRUE), 2),
            dqrlt65 = round(quantile(qfracr, probs = 0.65, na.rm = TRUE), 2),
            dqrlt75 = round(quantile(qfracr, probs = 0.75, na.rm = TRUE), 2),
            dqrlt90 = round(quantile(qfracr, probs = 0.90, na.rm = TRUE), 2),
            dqrlt95 = round(quantile(qfracr, probs = 0.95, na.rm = TRUE), 2),
            dqrlt98 = round(quantile(qfracr, probs = 0.98, na.rm = TRUE), 2),
            qrlt99 = round(quantile(qfracr, probs = 0.99, na.rm = TRUE), 2),
            dqrmax = round(max(qfracr), 2), 
            dqrcount = n(),
            dqrmean = round(mean(qfracr), 2),
            dqrsd = round(sd(qfracr), 2),
            pltave = round(mean(pave_annual)),
            tltave = round(mean(tave_annual), 2)
              ) %>%
  ungroup()
dq_cc50_long <- dq_cc50 %>%
  dplyr::mutate(era = as.integer(era)) %>%
  dplyr::select(-dqrcount, -dqrsd, -pltave, -tltave,
                -dqrlt35, -dqrlt65, -dqrmean, 
                -dqrmax) %>%
  tidyr::gather(key = "stat", value = "val", -era)

dq_cc25 <- dq_cc25.runs.df %>%
  group_by(era) %>%
  summarise(dqrmin = round(min(qfracr), 2),
            dqrlt01 = round(quantile(qfracr, probs = 0.01, na.rm = TRUE), 2),
            dqrlt02 = round(quantile(qfracr, probs = 0.02, na.rm = TRUE), 2),
            dqrlt05 = round(quantile(qfracr, probs = 0.05, na.rm = TRUE), 2),
            dqrlt10 = round(quantile(qfracr, probs = 0.10, na.rm = TRUE), 2),
            dqrlt25 = round(quantile(qfracr, probs = 0.25, na.rm = TRUE), 2),
            dqrlt35 = round(quantile(qfracr, probs = 0.35, na.rm = TRUE), 2),
            dqrlt50 = round(quantile(qfracr, probs = 0.50, na.rm = TRUE), 2),
            dqrlt65 = round(quantile(qfracr, probs = 0.65, na.rm = TRUE), 2),
            dqrlt75 = round(quantile(qfracr, probs = 0.75, na.rm = TRUE), 2),
            dqrlt90 = round(quantile(qfracr, probs = 0.90, na.rm = TRUE), 2),
            qrlt95 = round(quantile(qfracr, probs = 0.95, na.rm = TRUE), 2),
            qrlt98 = round(quantile(qfracr, probs = 0.98, na.rm = TRUE), 2),
            qrlt99 = round(quantile(qfracr, probs = 0.99, na.rm = TRUE), 2),
            dqrmax = round(max(qfracr), 2), 
            dqrcount = n(),
            dqrmean = round(mean(qfracr), 2),
            dqrsd = round(sd(qfracr), 2),
            pltave = round(mean(pave_annual)),
            tltave = round(mean(tave_annual), 2)
              ) %>%
  ungroup()
dq_cc25_long <- dq_cc25 %>%
  dplyr::mutate(era = as.integer(era)) %>%
  dplyr::select(-dqrcount, -dqrsd, -pltave, -tltave,
                -dqrlt35, -dqrlt65, -dqrmean, 
                -dqrmax) %>%
  tidyr::gather(key = "stat", value = "val", -era)

dq_cc10 <- dq_cc10.runs.df %>%
  group_by(era) %>%
  summarise(dqrmin = round(min(qfracr), 2),
            dqrlt01 = round(quantile(qfracr, probs = 0.01, na.rm = TRUE), 2),
            dqrlt02 = round(quantile(qfracr, probs = 0.02, na.rm = TRUE), 2),
            dqrlt05 = round(quantile(qfracr, probs = 0.05, na.rm = TRUE), 2),
            dqrlt10 = round(quantile(qfracr, probs = 0.10, na.rm = TRUE), 2),
            dqrlt25 = round(quantile(qfracr, probs = 0.25, na.rm = TRUE), 2),
            dqrlt35 = round(quantile(qfracr, probs = 0.35, na.rm = TRUE), 2),
            dqrlt50 = round(quantile(qfracr, probs = 0.50, na.rm = TRUE), 2),
            dqrlt65 = round(quantile(qfracr, probs = 0.65, na.rm = TRUE), 2),
            dqrlt75 = round(quantile(qfracr, probs = 0.75, na.rm = TRUE), 2),
            dqrlt90 = round(quantile(qfracr, probs = 0.90, na.rm = TRUE), 2),
            qrlt95 = round(quantile(qfracr, probs = 0.95, na.rm = TRUE), 2),
            qrlt98 = round(quantile(qfracr, probs = 0.98, na.rm = TRUE), 2),
            qrlt99 = round(quantile(qfracr, probs = 0.99, na.rm = TRUE), 2),
            dqrmax = round(max(qfracr), 2), 
            dqrcount = n(),
            dqrmean = round(mean(qfracr), 2),
            dqrsd = round(sd(qfracr), 2),
            pltave = round(mean(pave_annual)),
            tltave = round(mean(tave_annual), 2)
              ) %>%
  ungroup()
dq_cc10_long <- dq_cc10 %>%
  dplyr::mutate(era = as.integer(era)) %>%
  dplyr::select(-dqrcount, -dqrsd, -pltave, -tltave,
                -dqrlt35, -dqrlt65, -dqrmean, 
                -dqrmax) %>%
  tidyr::gather(key = "stat", value = "val", -era)

dq_cc_all.runs <- q_met.fannual.df %>%
    group_by(era) %>%
  summarise(dqrmin = round(min(qfracr), 2),
            dqrlt01 = round(quantile(qfracr, probs = 0.01, na.rm = TRUE), 2),
            dqrlt02 = round(quantile(qfracr, probs = 0.02, na.rm = TRUE), 2),
            dqrlt05 = round(quantile(qfracr, probs = 0.05, na.rm = TRUE), 2),
            dqrlt10 = round(quantile(qfracr, probs = 0.10, na.rm = TRUE), 2),
            dqrlt25 = round(quantile(qfracr, probs = 0.25, na.rm = TRUE), 2),
            dqrlt35 = round(quantile(qfracr, probs = 0.35, na.rm = TRUE), 2),
            dqrlt50 = round(quantile(qfracr, probs = 0.50, na.rm = TRUE), 2),
            dqrlt65 = round(quantile(qfracr, probs = 0.65, na.rm = TRUE), 2),
            dqrlt75 = round(quantile(qfracr, probs = 0.75, na.rm = TRUE), 2),
            dqrlt90 = round(quantile(qfracr, probs = 0.90, na.rm = TRUE), 2),
            dqrlt95 = round(quantile(qfracr, probs = 0.95, na.rm = TRUE), 2),
            dqrlt98 = round(quantile(qfracr, probs = 0.98, na.rm = TRUE), 2),
            qrlt99 = round(quantile(qfracr, probs = 0.99, na.rm = TRUE), 2),
            dqrmax = round(max(qfracr), 2), 
            dqrcount = n(),
            dqrmean = round(mean(qfracr), 2),
            dqrsd = round(sd(qfracr), 2),
            pltave = round(mean(pave_annual)),
            tltave = round(mean(tave_annual), 2)
              ) %>%
  ungroup()
dq_cc_all_long <- dq_cc_all.runs %>%
  dplyr::mutate(era = as.integer(era)) %>%
  dplyr::select(-dqrcount, -dqrsd, -pltave, -tltave,
                -dqrlt35, -dqrlt65, -dqrmean, 
                -dqrmax) %>%
  tidyr::gather(key = "stat", value = "val", -era)


```

### Plot the filtered runs, grouped by the long-term mean flow in era=2050:
```{r}
ggplot(data = dq_cc90.runs.df, aes(x = year, y = qfracr))  +
  geom_line(aes(colour = run)) +
  ggtitle("dqr renormalized 15% of runs centered around 10th percentile mean") +
  labs(x = "Year", y = "Percent change in flow from mean baseline") +
  scale_y_continuous(limits = c(0, 3))
ggplot(data = dq_cc75.runs.df, aes(x = year, y = qfracr))  +
  geom_line(aes(colour = run)) +
  ggtitle("dqr renormalized 15% of runs centered around 25th percentile mean") +
  labs(x = "Year", y = "Percent change in flow from mean baseline") +
  scale_y_continuous(limits = c(0, 3))
ggplot(data = dq_cc50.runs.df, aes(x = year, y = qfracr))  +
  geom_line(aes(colour = run)) +
  ggtitle("dqr renormalized 15% of runs centered around 50th percentile mean") +
  labs(x = "Year", y = "Percent change in flow from mean baseline") +
  scale_y_continuous(limits = c(0, 3))
ggplot(data = dq_cc25.runs.df, aes(x = year, y = qfracr))  +
  geom_line(aes(colour = run)) +
  ggtitle("dqr renormalized 15% of runs centered around 75th percentile mean") +
  labs(x = "Year", y = "Percent change in flow from mean baseline") +
  scale_y_continuous(limits = c(0, 3))
ggplot(data = dq_cc10.runs.df, aes(x = year, y = qfracr))  +
  geom_line(aes(colour = run)) +
  ggtitle("dqr renormalized 15% of runs centered around 90th percentile mean") +
  labs(x = "Year", y = "Percent change in flow from mean baseline") +
  scale_y_continuous(limits = c(0, 3))
```


### Also want to characterize temperature and precipitation. For now just focus on cc50. dq_cc50.df 


```{r}
ggplot(data = dq_cc10_long, aes(x = era, y = val))  +
  geom_line(aes(colour = stat)) +
  ggtitle("cc10: quantiles of long-term mean dq's") +
  labs(x = "Year", y = "Percent change in flow") +
  scale_y_continuous(limits = c(0.0, 2.2), breaks = seq(0.0, 2.2, 0.2))
ggplot(data = dq_cc25_long, aes(x = era, y = val))  +
  geom_line(aes(colour = stat)) +
  ggtitle("cc25: quantiles of long-term mean dq's") +
  labs(x = "Year", y = "Percent change in flow") +
  scale_y_continuous(limits = c(0.0, 2.2), breaks = seq(0.0, 2.2, 0.2))
ggplot(data = dq_cc50_long, aes(x = era, y = val))  +
  geom_line(aes(colour = stat)) +
  ggtitle("cc50: Annual dq quantiles of runs with lt means near 50th percentile") +
  labs(x = "Year", y = "Percent change in flow") +
  scale_y_continuous(limits = c(0.0, 2.2), breaks = seq(0.0, 2.2, 0.2))
ggplot(data = dq_cc75_long, aes(x = era, y = val))  +
  geom_line(aes(colour = stat)) +
  ggtitle("cc75: quantiles of long-term mean dq's") +
  labs(x = "Year", y = "Percent change in flow") +
  scale_y_continuous(limits = c(0.0, 2.2), breaks = seq(0.0, 2.2, 0.2))
ggplot(data = dq_cc90_long, aes(x = era, y = val))  +
  geom_line(aes(colour = stat)) +
  ggtitle("cc90: quantiles of long-term mean dq's") +
  labs(x = "Year", y = "Percent change in flow") +
  scale_y_continuous(limits = c(0.0, 2.2), breaks = seq(0.0, 2.2, 0.2))
```

### Flow changes for very dry scenario (cc90 - 10% risk in terms of drought)
```{r}
dq_cc90 <- dq_cc90 #%>%
  # dplyr::select(-dqrcount, -dqrsd, -pltave, -tltave,
  #               -dqrlt35, -dqrlt65, -dqrmean, 
  #               -dqrmax) %>%
knitr::kable(dq_cc90)
```

### Flow changes for moderately dry scenario (cc75 - 25% risk) 
```{r}
dq_cc75 <- dq_cc75 #%>%
  # filter(era == 1965 | era == 2050)
knitr::kable(dq_cc75)
```

### Flow changes for average scenario (cc50 - 50% risk)
```{r}
dq_cc50 <- dq_cc50 #%>%
  # filter(era == 1965 | era == 2050)
knitr::kable(dq_cc50)
```

### Flow changes for moderately wet scenario (cc25)
```{r}
dq_cc25 <- dq_cc25 #%>%
  # filter(era == 1965 | era == 2050)
knitr::kable(dq_cc25)
```

### Flow changes for very wet scenario (cc10)
```{r}
dq_cc10 <- dq_cc10 #%>%
  # filter(era == 1965 | era == 2050)
knitr::kable(dq_cc10)
```

### Flow changes for all filtered runs
```{r}
dq_cc_all.runs <- dq_cc_all.runs #%>%
  # filter(era == 1965 | era == 2050)
knitr::kable(dq_cc_all.runs)
```

```{r}
# Remove objects that are no longer useful to clean up the global environment.
#rm(with.df, withdrawals.df, pot.total)
```

